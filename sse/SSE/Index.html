<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ServiceStack SEE Issue Reproducer</title>
    
    <script src="Scripts/jquery-2.1.1.min.js"></script>
    <script src="Scripts/eventsource.js"></script>
    <script src="Scripts/ss-utils.js"></script>
</head>
<body>
    <h1>ServiceStack SEE Issue Reproducer</h1>
    <button type="button" onclick="ssRequest()">Request SS</button>
    <p id="demo"></p>
    
    <script>
        function ssRequest() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("demo").innerHTML = this.responseText;
                }
            };
            xhttp.open("GET", "hello?name=test_name&t=" + Math.random(), true);
            xhttp.send();
        }

        function createSubscription() {
            var es = new EventSource('sse/event-stream?channels=autoupdate&t=' + new Date().getTime());

            $(es).handleServerEvents({
                handlers: {
                    onConnect: function (subscription) {
                        console.log("onConnect: subscription.id=" + subscription.id);
                    },
                    onReconnect: function (es, errorArgs) {
                        console.log("onReconnect: StatusText=" + es.statusText);
                    },
                    onStop: function () {
                        console.log("onStop: url=" + this.url);
                    },
                    stopListening: function () {
                        console.log("stopListening");
                    }
                },
                success: function (selector, msg, json) {
                    console.log(selector, msg, json);
                }
            });
        }

        createSubscription();

    </script>

</body>
</html>